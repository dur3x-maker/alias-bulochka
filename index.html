<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alias для булочки</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#111827;
      --muted:#9ca3af;
      --text:#e5e7eb;
      --accent:#22c55e;
      --accent2:#3b82f6;
      --danger:#ef4444;
      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --radius: 16px;
      --ring: 0 0 0 3px rgba(34,197,94,.25);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 800px at 20% 0%, rgba(59,130,246,.18), transparent 60%),
                  radial-gradient(1000px 700px at 90% 20%, rgba(34,197,94,.15), transparent 55%),
                  var(--bg);
      color:var(--text);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .app{
      min-height:100%;
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding:16px;
    }
    .wrap{
      width:min(520px, 100%);
      margin:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }
    h1,h2,h3{margin:0 0 8px 0; letter-spacing:.2px}
    h1{font-size:26px}
    h2{font-size:20px; color:#f3f4f6}
    p{margin:0 0 12px 0; color:var(--muted); line-height:1.5}

    .row{display:flex; gap:10px; align-items:center}
    .row > *{flex:1}

    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px 0}
    input[type="text"], input[type="number"], select{
      width:100%;
      padding:12px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    input[type="text"]:focus, input[type="number"]:focus, select:focus{box-shadow:var(--ring); border-color: rgba(34,197,94,.35)}

    input[type="range"]{width:100%}

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      width:100%;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:650;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{background: rgba(34,197,94,.18); border-color: rgba(34,197,94,.35)}
    .btn.primary:focus{outline:none; box-shadow:var(--ring)}
    .btn.big{padding:16px 14px; font-size:18px}
    .btn.green{background: rgba(34,197,94,.22); border-color: rgba(34,197,94,.45)}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .btn[disabled]:active{transform:none}

    .mini{
      width:auto;
      padding:10px 12px;
      border-radius: 12px;
      flex:0 0 auto;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
    }

    .list{display:flex; flex-direction:column; gap:10px}
    .teamRow{display:flex; gap:10px; align-items:center}
    .teamRow .name{flex:1}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color:var(--text);
      font-size:12px;
      white-space:nowrap;
    }

    .scoreTable{display:flex; flex-direction:column; gap:8px}
    .scoreItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .scoreItem.current{border-color: rgba(59,130,246,.45); background: rgba(59,130,246,.12)}
    .scoreName{font-weight:650}
    .scorePts{font-variant-numeric: tabular-nums; color:#f9fafb}
    .scorePts.negative{color:#fca5a5}

    .modeGrid{display:grid; grid-template-columns:1fr; gap:10px}
    .mode{
      text-align:left;
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      cursor:pointer;
    }
    .mode.selected{border-color: rgba(34,197,94,.45); background: rgba(34,197,94,.10)}
    .modeTitle{font-weight:750; margin-bottom:4px}
    .modeMeta{font-size:12px; color:var(--muted); line-height:1.4}

    .roundStage{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .topBar{display:flex; justify-content:space-between; gap:10px; align-items:center}
    .timer{
      font-variant-numeric: tabular-nums;
      font-weight:800;
      letter-spacing:.6px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
    }
    .timer.danger{border-color: rgba(239,68,68,.45); color:#fecaca}

    .wordCard{
      user-select:none;
      touch-action:none;
      text-align:center;
      padding:24px 16px;
      min-height:40vh;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.14));
    }
    .word{
      font-size:34px;
      font-weight:900;
      letter-spacing:.4px;
      line-height:1.05;
      word-break:break-word;
    }
    .swipeHelp{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
    }

    .resultList{display:flex; flex-direction:column; gap:8px}
    .res{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .mark{font-size:16px; width:24px; text-align:center}
    .resWord{flex:1}

    .footerNote{font-size:12px; color:var(--muted); text-align:center; padding:4px 0}

    @media (min-width: 520px){
      h1{font-size:30px}
      .word{font-size:42px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div id="app" class="wrap"></div>
  </div>

  <script>
  (function(){
    'use strict';

    const APP = document.getElementById('app');

    const TEAM_NAME_POOL = [
      'Пельмешки','Принцесски','Цветочки','Кабачки','Котики','Огурчики','Пончики','Круассаны','Капибары','Лисички',
      'Сырники','Пирожочки','Мандаринки','Енотики','Мишутки','Клубнички','Лимончики','Пандачки','Сосисочки','Шалунчики'
    ];

    function clampInt(v, min, max, fallback){
      const n = Number.parseInt(v, 10);
      if (!Number.isFinite(n)) return fallback;
      return Math.min(max, Math.max(min, n));
    }

    function safeText(s, fallback){
      const t = (s ?? '').toString().trim();
      return t.length ? t : fallback;
    }

    function shuffleInPlace(arr){
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function pickRandom(arr){
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function formatTime(sec){
      const s = Math.max(0, Math.floor(sec));
      const m = Math.floor(s / 60);
      const r = s % 60;
      return m > 0 ? `${m}:${String(r).padStart(2,'0')}` : `${r}`;
    }

    const audio = {
      ctx: null,
      ensure(){
        if (!this.ctx) {
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (!Ctx) return null;
          this.ctx = new Ctx();
        }
        if (this.ctx.state === 'suspended') this.ctx.resume().catch(()=>{});
        return this.ctx;
      },
      beep(freq, durMs, type='sine', gain=0.04){
        const ctx = this.ensure();
        if (!ctx) return;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = type;
        o.frequency.value = freq;
        g.gain.value = gain;
        o.connect(g);
        g.connect(ctx.destination);
        const t0 = ctx.currentTime;
        const t1 = t0 + durMs/1000;
        g.gain.setValueAtTime(gain, t0);
        g.gain.exponentialRampToValueAtTime(0.0001, t1);
        o.start(t0);
        o.stop(t1);
      },
      correct(){
        this.beep(880, 120, 'sine', 0.05);
      },
      wrong(){
        const ctx = this.ensure();
        if (!ctx) return;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sawtooth';
        g.gain.value = 0.035;
        o.connect(g);
        g.connect(ctx.destination);
        const t0 = ctx.currentTime;
        o.frequency.setValueAtTime(220, t0);
        o.frequency.exponentialRampToValueAtTime(90, t0 + 0.22);
        g.gain.setValueAtTime(0.035, t0);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.25);
        o.start(t0);
        o.stop(t0 + 0.26);
      },
      warning(){
        this.beep(740, 90, 'square', 0.035);
      }
    };

    const WORDS = {
      kids: [
        'кот','собака','мяч','дом','мама','папа','бабушка','дедушка','школа','книга','ручка','карандаш','яблоко','банан','груша','слива','вишня','арбуз','дыня','морковь','картошка','огурец','помидор','капуста','суп','каша','хлеб','сыр','молоко','чай','ложка','вилка','тарелка','чашка','кровать','подушка','одеяло','шкаф','стол','стул','окно','дверь','ключ','сумка','куртка','шапка','шарф','ботинок','носок','перчатка','зонт','снег','дождь','ветер','солнце','облако','радуга','звезда','луна','море','река','озеро','лес','гора','трава','цветок','дерево','лист','ветка','шишка','песок','камень','кошка','птица','рыба','лошадь','корова','овца','коза','свинья','утка','гусь','курица','цыплёнок','лягушка','ёж','заяц','лиса','волк','медведь','белка','мышь','хомяк','черепаха','слон','жираф','тигр','лев','обезьяна','крокодил','дельфин','акула','корабль','самолёт','поезд','машина','автобус','велосипед','самокат','санки','качели','горка','парк','игра','кукла','робот','конструктор','пазл','мячик','подарок','праздник','ёлка','свеча','шарик','конфета','печенье','торт','мороз','письмо','открытка','фото','рисунок','краска','кисть','мел','доска','тетрадь','дневник','урок','перемена','учитель','класс','друг','подруга','семья','улыбка','смех','слеза','сон','сказка','мультик','театр','цирк','арена','клоун','фокус','флаг','герб','карта','глобус','страна','город','улица','двор','подъезд','лифт','лестница','площадка','кран','ванна','душ','мыло','полотенце','зуб','щётка','паста','расчёска','зеркало','пол','потолок','стена','лампа','свет','тень','песенка','музыка','барабан','гитара','пианино','нотка','скрипка','труба','кнопка','телефон','планшет','экран','картинка','письменник','альбом','маркер','линейка','ластик','пенал','рюкзак','портфель','подарочек','каток','коньки','лыжи','шлем','мяч','ворота','команда','победа','медаль','кубок',
        'колесо','руль','дорога','светофор','пешеход','тротуар','переход','магазин','рынок','касса','монета','купюра','кошелёк','игрушка','шар','кубик','пирамида','кружка','чайник','кастрюля','сковорода','плита','духовка','холодильник','морозилка','конфитюр','варенье','йогурт','сметана','масло','колбаса','сосиска','котлета','макароны','рис','гречка','овсянка','салат','сок','вода','лимонад','морс','компот','сахар','соль','перец','тесто','мука','яйцо','курочка','петух','гнездо','перо','клюв','крыло','хвост','лапа','усы','шерсть','пятно','полоска','точка','круг','квадрат','треугольник','цифра','буква','слово','фраза','вопрос','ответ','звонок','будильник','часы','минутка','секунда','весна','лето','осень','зима','январь','февраль','март','апрель','май','июнь','июль','август','сентябрь','октябрь','ноябрь','декабрь','утро','день','вечер','ночь','пальто','жилет','футболка','рубашка','платье','юбка','шорты','джинсы','ремень','пуговица','молния','карман','шнурок','шнур','лента','бантик','кольцо','браслет','серёжка','цепочка','коробка','пакет','бумага','газета','журнал','страница','обложка','закладка','клей','ножницы','скрепка','булавка','иголка','нитка','пуговка','ковёр','штора','полка','комод','диван','кресло','табурет','балкон','кухня','комната','спальня','ванная','коридор','дворник','почтальон','врач','медсестра','пожарный','полицейский','повар','пекарь','строитель','водитель','пилот','капитан','продавец','кассир','учитель','ученик','малыш','ребёнок','мальчик','девочка', 'шарик','фонарик','самосвал','трактор','экскаватор','паровоз','вагон','локомотив','рюкзачок','пенёк','лужа','капелька','пузырь','пузырик','брызги','ведёрко','лопатка','совочек','песочница','крепость','башенка','домик','шалаш','палатка','фонарик','морячок','капитанчик','матрос','якорь','парус','штурвал','карта','компас','звёздочка','планетка','ракетка','космонавт','скафандр','шлемчик','пульт','кнопочка','лампочка','батарейка','проводок','розеточка','выключатель','подоконник','занавеска','скатерть','салфеточка','подставка','коробочка','мешочек','узелок','верёвочка','ленточка','бантик','флажок','гирлянда','свисток','дудочка','бубенчик','колокольчик','погремушка','юла','волчок','катушка','кубики','домино','лото','кегля','шашки','пальчик','ладошка','локоток','коленочка','пяточка','носик','ушки','глазик','ротик','язычок','бровка','ресничка','чёлка','косичка','расчёска','зажим','заколка','ободок','шнурочек','пуговка','платочек','фартук','жилетик','варежка','рукавчик','капюшон','лужайка','полянка','тропинка','овражек','пригорок','холмик','скворечник','кормушка','зернышко','крошка','семечко','ягодка','грибочек','опёнок','маслёнок','подберёзовик','лисичка'
      ],
      newbie: [
        'кафе','пицца','паста','бургер','кофе','капучино','латте','чайник','термос','сковорода','кастрюля','пельмени','омлет','салат','гарнир','соус','десерт','мороженое','шоколад','карамель','мармелад','зефир','халва','пирог','кекс','маффин','булочка','круассан','багет','батон','сырник','оливье','винегрет','окрошка','борщ','лапша','пюре','котлета','шашлык','рыба','креветка','мидия','кальмар','икра','арбуз','ананас','манго','киви','лимон','апельсин','гранат','персик','абрикос','черника','малина','клубника','смородина','крыжовник','помидор','огурец','баклажан','кабачок','перец','редис','репа','свёкла','чеснок','лук','укроп','петрушка','базилик','имбирь','корица','ваниль','сахарница','солонка','салфетка','скатерть','поднос','чек','скидка','витрина','меню','заказ','доставка','упаковка','пакет','коробка','подарок','сюрприз','открытка','праздник','фейерверк','свеча','гирлянда','шарик','ёлка','карнавал','костюм','маска','грим','сцена','концерт','музыка','песня','ритм','гитара','пианино','саксофон','скрипка','барабан','микрофон','колонка','наушники','плейлист','фильм','сериал','театр','комедия','драма','триллер','детектив','актёр','режиссёр','сценарий','премьера','билет','афиша','музей','картина','скульптура','экспонат','галерея','парк','аллея','фонтан','скамейка','площадь','набережная','переулок','проспект','остановка','маршрут','автобус','трамвай','метро','переход','светофор','пробка','парковка','двигатель','руль','шина','ремень','багажник','навигатор','самокат','велосипед','шлем','перчатка','куртка','пальто','пиджак','платье','юбка','футболка','кроссовок','ботинок','шарф','шапка','зонт','кошелёк','монета','купюра','карта','пинкод','банкомат','перевод','счёт','квитанция','подписка','пароль','логин','профиль','сообщение','чат','смайлик','фото','видео','кадр','фильтр','стикер','пост','лайк','репост','комментарий','новость','погода','прогноз','ветер','дождь','мороз','гроза','облако','радуга','звезда','планета','комета','спутник','телескоп','карта','глобус','рельеф','граница','столица','город','деревня','посёлок','улица','квартира','комната','кухня','ванная','балкон','коридор','лифт','лестница','подъезд','сосед','ремонт','обои','плитка','лампа','розетка','выключатель','пульт','канал','новичок','удача','попытка','ошибка','победа','награда','медаль','кубок','команда','счёт','раунд','таймер',
        'салон','парикмахер','стрижка','шампунь','кондиционер','крем','пудра','помада','тушь','маникюр','педикюр','духи','аромат','букет','цветы','ромашка','тюльпан','роза','пион','ландыш','букетик','упаковщик','курьер','почта','посылка','трек','уведомление','будильник','календарь','встреча','звонок','контакт','адрес','улица','домофон','ключ','замок','сейф','полка','шкаф','комод','диван','кресло','ковёр','штора','подушка','одеяло','простыня','плед','чайная','стакан','фужер','бокал','штопор','пробка','бутылка','графин','соковыжималка','блендер','миксер','духовка','гриль','тостер','вафельница','посудомойка','тряпка','губка','ведро','швабра','порошок','кондиционер','пылесос','шум','тишина', 'бариста','официант','кухня','рецепт','ингредиент','порция','закуска','напиток','айсберг','рукола','моцарелла','пармезан','соевый','терияки','кунжут','фудкорт','кафетерий','столовая','терраса','веранда','балкончик','маркетплейс','корзина','оформление','оплата','чекер','подтверждение','подкаст','стрим','ведущий','подписчик','аудитория','просмотр','сервер','провайдер','роутер','модем','подключение','скорость','приложение','обновление','версия','настройка','уведомление','скриншот','запись','трансляция','загрузка','пауза','перемотка','маршрутка','каршеринг','велопрокат','парковщик','шлагбаум','курьерка','самовывоз','доставка','упаковка','пломба','наклейка','сторис','лента','обложка','описание','хештег','упоминание','гардероб','примерка','витраж','зеркальце','освещение','витрина','коворкинг','офис','переговорка','планёрка','бриф','дедлайн','задачка','чеклист','таблица','отчёт','график','расписание','будни','выходные','отпуск','путёвка','чемодан','багаж','хостел','апартаменты','заселение','ресепшен','ключкарта','экскурсия','гид','маршрут','остановка','локация','панорама','сувенир','магнитик','открыточка','фотоальбом','память'
      ],
      medium: [
        'аквариум','антиквариат','архив','аукцион','библиография','биография','бухгалтерия','вакансия','вдохновение','впечатление','воспоминание','воспитание','выпускник','гипотеза','гражданство','дисциплина','договорённость','должность','достоверность','доступность','драматургия','единство','журналистика','задолженность','закономерность','замечание','заявление','изобретение','импровизация','инструкция','интерпретация','квалификация','коммуникация','компетенция','конфигурация','концепция','координация','критерий','лаборатория','лекция','литература','логистика','модернизация','монография','мотивация','наблюдение','наследие','необходимость','обсуждение','обязательство','оптимизация','организация','ориентация','парадигма','перспектива','подтверждение','показатель','постановка','потребность','предпосылка','преимущество','препятствие','привычка','приложение','принцип','приоритет','проблематика','прогнозирование','проектирование','промежуток','противоречие','профилактика','процедура','публикация','разногласие','разработка','разрешение','расписание','рассуждение','реализация','рекомендация','репутация','ресурс','результативность','риск','соглашение','сопротивление','социальность','стабильность','статистика','стратегия','структура','субординация','сущность','тактика','тенденция','терминология','технология','требование','унификация','управление','уточнение','факультет','финансирование','функционал','характеристика','хронология','целесообразность','ценность','церемония','частота','экспертиза','эффективность',
        'аббревиатура','абстракция','аккредитация','активность','аналитика','аналогия','анкетирование','апробация','аргументация','ассортимент','ассоциация','атрибутика','аудитория','безопасность','блокировка','взаимодействие','внедрение','выражение','гарантия','гармония','декларация','демонстрация','детализация','диагностика','диалектика','диапазон','документация','допущение','достоверность','досуг','дружелюбие','заключение','зависимость','замысел','заинтересованность','законодательство','запрос','изменение','индикатор','инновация','интеграция','интенсивность','интервал','интуиция','исследование','источник','категория','календарь','качество','классификация','коллектив','коллизия','компенсация','компромисс','конкуренция','консультация','контроль','коэффициент','культура','куратор','лицензия','лидерство','локализация','маркетинг','масштабирование','медиатор','методология','механизм','модель','модерация','навигация','наименование','направление','настройка','обобщение','обучение','объективность','описание','оповещение','оппозиция','основание','отклонение','оценка','переменная','перемещение','переписка','планирование','платформа','повестка','положение','политика','помеха','порог','презентация','преподаватель','приложение','примечание','проверка','продвижение','продуктивность','процент','психология','публицистика','раздел','различие','рациональность','регламент','регистрация','регресс','редактура','реестр','реформа','решение','сигнал','система','ситуация','соглашение','сообщение','соответствие','срок','сценарий','таблица','теория','тестирование','транзакция','трансформация','триггер','указание','условие','участник','фестиваль','формула','фундамент','целеполагание','эволюция','экология','экономика','этика','юрисдикция','инициатива','кооперация','согласование','обоснование','пояснение','обновление','переосмысление','корректировка','систематизация','классификатор','обобщённость','иерархия','градация','масштаб','пропорция','соотношение','структурирование','комбинация','альтернатива','вариантность','адаптация','реорганизация','модификация','оптимальность','целостность','устойчивость','вектор','направленность','сценарность','последовательность','параметр','критичность','достоверность','валидность','интерпретируемость','совместимость','согласованность','противоречивость','ограниченность','предельность','фактор','переменная','условность','допущение','обратная_связь','реакция','отклик','индикативность','метрика','показатель','коэффициент','оценочность','приемлемость','резон','обстоятельство','контекстуальность','среда','окружение','влияние','давление','устойчивость','сопряжение','взаимосвязь','взаимозависимость','коммуникабельность','координация','саморегуляция','прогнозируемость','вариабельность','цикличность','итерация','повторяемость','модельность','шаблон','паттерн','архитектура','каркас','основа','фундамент','нагрузка','распределение','балансировка','устойчивость'
      ],
      pro: [
        'ирония','парадокс','интуиция','иллюзия','манипуляция','двусмысленность','предвзятость','предубеждение','самообман','самоконтроль','самоуважение','самооценка','самокритика','самоирония','осознанность','впечатлительность','восприимчивость','эмпатия','апатия','энтузиазм','экстаз','эйфория','усталость','выгорание','вдохновение','мотивация','привязанность','ревность','зависть','гордость','стыд','вина','обида','разочарование','тревожность','уверенность','решимость','смелость','робость','сомнение','колебание','настойчивость','упрямство','терпение','вежливость','тактичность','деликатность','прямолинейность','сарказм','юмор','сатира','критика','похвала','комплимент','намёк','инсинуация','интрига','сплетня','слух','легенда','миф','символ','аллегория','метафора','образ','контраст','нюанс','полутон','подтекст','интонация','жест','мимика','взгляд','поза','харизма','обаяние','шарм','стиль','вкус','эстетика','гармония','дисгармония','баланс','дисбаланс','порядок','хаос','система','структура','логика','парадоксальность','вероятность','случайность','закономерность','тенденция','динамика','инерция','импульс','резонанс','атмосфера','настроение','контекст','обстановка','ритуал','традиция','обычай','обряд','церемония','этикет','кодекс','правило','исключение','компромисс','уступка','условие','запрет','разрешение','договор','соглашение','обязательство','ответственность','репутация','авторитет','престиж','статус','влияние','давление','контроль','надзор','цензура','самоцензура','провокация','шантаж','угроза','риск','опасность','подвох','ловушка','уловка','подмена','подлог','инсценировка','постановка','подстава','признание','оправдание','обвинение','улика','доказательство','свидетель','алиби','допрос','приговор','заслуга','наказание','прощение','искупление','милосердие','справедливость','несправедливость','равенство','неравенство','свобода','несвобода','зависимость','независимость','возможность','неизбежность','выбор','альтернатива','дилемма','цель','смысл','ценность','идеал','принцип','убеждение','мнение','позиция','точка','аргумент','контраргумент','доказательность','опровержение','сомнительность','очевидность','неясность','загадка','тайна','секрет','парад','маска','роль','образность','персона','личность','характер','темперамент','привычка','склонность','порок','добродетель','качество','недостаток','изъян','комплекс','фобия','наваждение','одержимость','искушение','соблазн','притяжение','отторжение','конфликт','противоречие','соперничество','конкуренция','альянс','союз','коалиция','перемирие','согласие','разногласие','вражда','дружба','преданность','верность','измена','лицемерие','искренность','откровенность','честность','ложь','обман','притворство','маскировка','туманность','определённость','уязвимость','защита','граница','дистанция','близость','интимность','доверие','подозрение','инсайт','озарение','догадка','идея','замысел','концепция','стратегия','тактика','план','сценарий','версии','интерпретация','объяснение','толкование','комментарий','суждение','оценка','критерий','мерило','предел','грани','размах','масштаб','сложность','простота','лаконичность','многословие','пауза','перерыв','ожидание','предвкушение','напряжение','разрядка','кульминация','развязка','финал','поворот','сюжет','интрига','завязка','пролог','эпилог','антураж','декорация','закулисье','репетиция','премьера','публика','аудитория','впечатление','восхищение','недоумение','шок','скандал','сенсация','конфуз','неловкость','провал','успех','прорыв','перелом','компенсация','переплата','дефицит','избыток','экономия','расточительность','жадность','щедрость','находчивость','сообразительность','хитрость','простодушие','наивность','цинизм','скепсис','оптимизм','пессимизм','реализм','романтика','ностальгия','меланхолия','вдохновение','воображение','фантазия','галлюцинация','сновидение','предчувствие','инстинкт','рефлекс','имитация','подражание','оригинальность','самобытность','эклектика','смешение','парадность','будничность','рутина','привычность','непривычность','случай','совпадение','подтверждение','подозрение','спекуляция','информация','дезинформация','инсайд','переговоры','сделка','торг','бартер','комиссия','посредник','консультант','покровитель','оппонент','союзник','наблюдатель','критик','ценитель','скептик','мечтатель','идеалист','прагматик'
      ],
      unreal: [
        'экзистенция','энтропия','диссонанс','когнитивность','абстракция','архетип','симулякр','парадокс','метафизика','онтология','эпистемология','интерпретация','интроспекция','интенция','амбивалентность','апория','конфликтность','контингентность','неопределённость','неизбежность','фатализм','детерминизм','случайность','хаос','гармония','анархия','утопия','антиутопия','идеология','догматизм','скептицизм','цинизм','нигилизм','эклектика','иррациональность','рациональность','интуиция','озарение','инсайт','самость','личность','идентичность','самоидентификация','саморефлексия','самообман','проекция','вытеснение','сублимация','катарсис','парадность','сакральность','профанность','табу','ритуал','мистерия','пророчество','знамение','фатум','карма','перерождение','искушение','соблазн','одержимость','наваждение','фанатизм','одержание','стигма','предрассудок','конформизм','нонконформизм','манипуляция','провокация','инсинуация','двойник','маска','персона','роль','аватар','мираж','иллюзия','галлюцинация','символ','аллегория','метафора','парабола','гротеск','абсурд','ирония','сарказм','сатира','пародия','пастиш','палимпсест','каламбур','подтекст','намёк','полутон','нюанс','контраст','дихотомия','дуализм','синтез','анализ','парадоксальность','инверсия','перевертыш','подмена','подлог','симуляция','мистификация','фальсификация','инсценировка','заговор','конспирация','паранойя','фобия','психоз','транс','медитация','созерцание','осознанность','просветление','озарение','вдохновение','воображение','фантазия','сновидение','предчувствие','инстинкт','интуитивность','внутренность','безмолвие','тишина','пауза','ожидание','предвкушение','напряжение','разрядка','кульминация','развязка','перелом','перемена','трансформация','метаморфоза','мутация','эволюция','деградация','регресс','прогресс','парад','кризис','катастрофа','коллапс','перезагрузка','обнуление','возрождение','ренессанс','ностальгия','меланхолия','экстаз','эйфория','апатия','тоска','тревога','паника','истерия','умиротворение','равнодушие','сочувствие','эмпатия','милосердие','жестокость','агрессия','враждебность','доброжелательность','преданность','верность','измена','лицемерие','искренность','откровенность','доверие','подозрение','ревность','зависть','гордость','стыд','вина','искупление','прощение','справедливость','несправедливость','равенство','неравенство','свобода','зависимость','граница','предел','барьер','лабиринт','тупик','развилка','перепутье','дилемма','парадокс','выбор','случай','совпадение','знак','сигнал','послание','намёк','шифр','код','ключ','пароль','тайна','секрет','загадка','ребус','головоломка','аксиома','догма','ересь','притча','легенда','миф','сказание','эпос','баллада','симфония','каденция','ритм','дисгармония','какофония','эхо','резонанс','вибрация','отклик','отражение','зеркало','двойник','тень','силуэт','контур','пространство','пустота','бездна','пропасть','горизонт','перспектива','параллакс','временность','вечность','мгновение','прошлое','будущее','настоящее','петля','спираль','цикл','поворот','порог','рубеж','портал','переход','путешествие','странствие','скитание','паломничество','одиссея','экспедиция','авантюра','квест','испытание','инициация','посвящение','пробуждение','прозрение','признание','откровение','забвение','амнезия','воспоминание','ретроспектива','предание','хроника','летопись','анналы','архив','артефакт','реликвия','фетиш','талисман','амулет','трофей','символика','знамя','эмблема','тотем','идол','пантеон','олимп','валгалла','нифльхейм','асгард','герой','антигерой','трикстер','призрак','фантом','оборотень','вампир','русалка','домовой','леший','кикимора','ведьма','колдун','чародей','алхимик','философ','оракул','пророк','шаман','пилигрим','скиталец','изгой','отшельник','аскет','монах','еретик','мученик','просветитель','вдохновитель','провидец','стратег','манипулятор','мистификатор','провокатор','анархист','идеалист','прагматик','реалист','романтик','циник','скептик','утопист','футурист','ретроград','новатор','авангард','сюрреализм','импрессионизм','экспрессионизм','символизм','модернизм','постмодернизм','деконструкция','конструкт','нарратив','дискурс','парадигма','сингулярность','фрактал','энтропия','резонанс'
      ]
    };

    const BASE_EXT = [
      'абажур','абрикос','аватар','аврал','агент','адрес','азарт','аккорд','алгоритм','аллея','альянс','ампула','ангар','анекдот','анкета','анонс','аппарат','апрель','арбитр','аренда','аромат','арсенал','аспект','атлас','аудит','афиша','базар','баланс','балкон','баннер','барьер','бассейн','батарея'
    ];

    function ensureMinWords(arr, min){
      if (arr.length >= min) return arr;
      const out = arr.slice();
      let i = 0;
      while (out.length < min) {
        out.push(BASE_EXT[i % BASE_EXT.length]);
        i++;
      }
      return out;
    }

    WORDS.kids = ensureMinWords(WORDS.kids, 320);
    WORDS.newbie = ensureMinWords(WORDS.newbie, 320);
    WORDS.medium = ensureMinWords(WORDS.medium, 320);
    ensureMinWords(WORDS.pro, 320);
    ensureMinWords(WORDS.unreal, 320);

    const MODES = [
      {key:'kids', title:'Детский', meta:'Без штрафа. Идеально, чтобы разогреться.' , skipPenalty:false},
      {key:'newbie', title:'Новичок', meta:'Без штрафа. Комфортно и бодро.', skipPenalty:false},
      {key:'medium', title:'Медиум', meta:'Штраф −1 за пропуск. Уже честно.', skipPenalty:true},
      {key:'pro', title:'Профи', meta:'Штраф −1. Слова требуют концентрации.', skipPenalty:true},
      {key:'unreal', title:'UNREAL', meta:'Штраф −1. Сложные термины, но без ада.', skipPenalty:true}
    ];

    const state = {
      screen: 0,
      teamsCount: 2,
      teams: [
        {id: cryptoSafeId(), name: 'Котики', score: 0},
        {id: cryptoSafeId(), name: 'Пельмешки', score: 0}
      ],
      settings: {
        roundSeconds: 60,
        winScore: 30
      },
      modeKey: 'newbie',
      turnIndex: 0,
      decks: {},
      round: null,
      winnerTeamId: null
    };

    function cryptoSafeId(){
      if (window.crypto && crypto.getRandomValues) {
        const a = new Uint32Array(2);
        crypto.getRandomValues(a);
        return `${a[0].toString(16)}${a[1].toString(16)}`;
      }
      return String(Math.random()).slice(2) + String(Date.now());
    }

    function currentTeam(){
      return state.teams[state.turnIndex] || state.teams[0];
    }

    function mode(){
      return MODES.find(m => m.key === state.modeKey) || MODES[1];
    }

    function initDecksIfNeeded(){
      if (state.decks && Object.keys(state.decks).length) return;
      state.decks = {};
      for (const m of MODES) {
        const deck = WORDS[m.key].slice();
        shuffleInPlace(deck);
        state.decks[m.key] = {deck, cursor: 0};
      }
    }

    function nextWord(usedSet){
      initDecksIfNeeded();
      const d = state.decks[state.modeKey];
      if (!d) return 'слово';
      for (let tries = 0; tries < 2000; tries++) {
        if (d.cursor >= d.deck.length) {
          d.deck = shuffleInPlace(WORDS[state.modeKey].slice());
          d.cursor = 0;
        }
        const w = d.deck[d.cursor++];
        const word = safeText(w, 'слово');
        if (!usedSet.has(word)) return word;
      }
      return safeText(d.deck[(d.cursor - 1 + d.deck.length) % d.deck.length], 'слово');
    }
    function go(screen){
      state.screen = screen;
      render();
    }

    function resetGame(){
      state.screen = 0;
      state.teamsCount = 2;
      state.teams = [
        {id: cryptoSafeId(), name: 'Котики', score: 0},
        {id: cryptoSafeId(), name: 'Пельмешки', score: 0}
      ];
      state.settings.roundSeconds = 60;
      state.settings.winScore = 30;
      state.modeKey = 'newbie';
      state.turnIndex = 0;
      state.decks = {};
      state.round = null;
      state.winnerTeamId = null;
      render();
    }

    function startRound(){
      initDecksIfNeeded();
      const used = new Set();
      const word = nextWord(used);
      used.add(word);

      state.round = {
        teamId: currentTeam().id,
        startedAt: Date.now(),
        roundSeconds: clampInt(state.settings.roundSeconds, 30, 300, 60),
        endAt: Date.now() + clampInt(state.settings.roundSeconds, 30, 300, 60) * 1000,
        timeUp: false,
        warned: false,
        currentWord: word,
        used,
        items: [],
        timerHandle: null
      };

      go(4);
      tickRound();
      state.round.timerHandle = setInterval(tickRound, 200);
    }

    function stopRoundTimer(){
      if (state.round && state.round.timerHandle) {
        clearInterval(state.round.timerHandle);
        state.round.timerHandle = null;
      }
    }

    function remainingSeconds(){
      if (!state.round) return 0;
      const ms = state.round.endAt - Date.now();
      return ms / 1000;
    }

    function tickRound(){
      if (!state.round) return;
      const rem = remainingSeconds();
      if (!state.round.warned && rem <= 5 && rem > 0) {
        state.round.warned = true;
        audio.warning();
      }

      if (!state.round.timeUp && rem <= 0) {
        state.round.timeUp = true;
        stopRoundTimer();
        render();
        return;
      }

      if (state.screen === 4) render();
    }

    function applySwipe(result){
      if (!state.round) return;

      const r = mode();
      const w = safeText(state.round.currentWord, 'слово');

      if (result === 'ok') {
        state.round.items.push({word: w, result: 'ok'});
        audio.correct();
      } else {
        state.round.items.push({word: w, result: 'skip'});
        if (r.skipPenalty) audio.wrong();
        else audio.wrong();
      }

      const isLast = state.round.timeUp;
      if (isLast) {
        finalizeRound();
        return;
      }
      const next = nextWord(state.round.used);
      state.round.currentWord = next;
      state.round.used.add(next);
      render();
    }

    function roundScoreDelta(){
      if (!state.round) return 0;
      const r = mode();
      let delta = 0;
      for (const it of state.round.items) {
        if (it.result === 'ok') delta += 1;
        else delta += (r.skipPenalty ? -1 : 0);
      }
      return delta;
    }

    function finalizeRound(){
      stopRoundTimer();
      const delta = roundScoreDelta();
      const t = state.teams.find(x => x.id === state.round.teamId);
      if (t) t.score = (Number.isFinite(t.score) ? t.score : 0) + delta;
      const winTarget = clampInt(state.settings.winScore, 10, 200, 30);
      const winner = state.teams.find(x => (Number.isFinite(x.score) ? x.score : 0) >= winTarget);
      if (winner) {
        state.winnerTeamId = winner.id;
        go(7);
        return;
      }

      go(5);
    }

    function nextTurn(){
      state.turnIndex = (state.turnIndex + 1) % Math.max(1, state.teams.length);
      state.round = null;
      go(6);
    }

    function el(tag, attrs, children){
      const node = document.createElement(tag);
      if (attrs) {
        for (const [k,v] of Object.entries(attrs)) {
          if (k === 'class') node.className = v;
          else if (k === 'text') node.textContent = v;
          else if (k.startsWith('on') && typeof v === 'function') node.addEventListener(k.slice(2).toLowerCase(), v);
          else if (v === false || v === null || v === undefined) {}
          else node.setAttribute(k, String(v));
        }
      }
      if (children) {
        for (const c of children) {
          if (c === null || c === undefined) continue;
          if (typeof c === 'string') node.appendChild(document.createTextNode(c));
          else node.appendChild(c);
        }
      }
      return node;
    }

    function clear(node){
      while (node.firstChild) node.removeChild(node.firstChild);
    }

    function scoreTable(currentId){
      const box = el('div', {class:'scoreTable'});
      for (const t of state.teams) {
        const pts = Number.isFinite(t.score) ? t.score : 0;
        const ptsEl = el('div', {class: 'scorePts' + (pts < 0 ? ' negative' : ''), text: String(pts)});
        box.appendChild(
          el('div', {class:'scoreItem' + (t.id === currentId ? ' current' : '')}, [
            el('div', {class:'scoreName', text: t.name}),
            ptsEl
          ])
        );
      }
      return box;
    }

    function screenStart(){
      return el('div', {class:'card'}, [
        el('h1', {text:'Alias для булочки'}),
        el('p', {text:'Один телефон, одна команда = один человек. Передаёте устройство по кругу и стараетесь не уйти слишком глубоко в минус. Да, это возможно — и это нормально.'}),
        el('button', {class:'btn primary big', onClick: () => go(1)}, ['Ну что, сыграем?']),
        el('div', {class:'footerNote', text:'Совет: держите телефон вертикально. Управление — свайпами.'})
      ]);
    }

    function rebuildTeams(count){
      const n = clampInt(count, 1, 10, 2);
      const prev = state.teams.slice();
      const next = [];
      for (let i=0; i<n; i++) {
        const p = prev[i];
        next.push({
          id: p ? p.id : cryptoSafeId(),
          name: p ? safeText(p.name, `Команда ${i+1}`) : `Команда ${i+1}`,
          score: p && Number.isFinite(p.score) ? p.score : 0
        });
      }
      state.teamsCount = n;
      state.teams = next;
    }

    function screenTeams(){
      const list = el('div', {class:'list'});

      const countBox = el('div', {}, [
        el('label', {text:'Количество команд'}),
      ]);
      const countRow = el('div', {class:'row'}, []);

      function setTeamsCount(next){
        const n = clampInt(next, 1, 10, state.teamsCount);
        if (n === state.teamsCount) return;
        rebuildTeams(n);
        render();
      }

      const minusBtn = el('button', {
        class:'btn mini',
        type:'button',
        onClick: () => setTeamsCount(state.teamsCount - 1)
      }, ['−']);

      const value = el('div', {class:'pill', text: String(state.teamsCount)});

      const plusBtn = el('button', {
        class:'btn mini',
        type:'button',
        onClick: () => setTeamsCount(state.teamsCount + 1)
      }, ['+']);

      if (state.teamsCount <= 1) minusBtn.setAttribute('disabled','disabled');
      if (state.teamsCount >= 10) plusBtn.setAttribute('disabled','disabled');

      countRow.appendChild(minusBtn);
      countRow.appendChild(value);
      countRow.appendChild(plusBtn);
      countBox.appendChild(countRow);
      list.appendChild(countBox);

      state.teams.forEach((t, idx) => {
        const nameInput = el('input', {type:'text', value: t.name, placeholder: `Команда ${idx+1}`});
        nameInput.addEventListener('input', () => {
          t.name = safeText(nameInput.value, `Команда ${idx+1}`);
        });

        const dice = el('button', {class:'btn mini', onClick: () => {
          const name = pickRandom(TEAM_NAME_POOL);
          t.name = name;
          render();
        }}, ['🎲']);

        list.appendChild(
          el('div', {class:'teamRow'}, [
            el('div', {class:'name'}, [
              el('label', {text:`Команда ${idx+1}`}),
              nameInput
            ]),
            dice
          ])
        );
      });

      const nextBtn = el('button', {class:'btn primary', onClick: () => {
        state.teams.forEach((t, i) => t.name = safeText(t.name, `Команда ${i+1}`));
        go(2);
      }}, ['Далее']);

      return el('div', {class:'card'}, [
        el('h2', {text:'Настройка команд'}),
        el('p', {text:'Команда = один человек. Название можно придумать, а можно довериться кубику.'}),
        list,
        el('div', {style:'height:8px'}),
        nextBtn
      ]);
    }

    function screenSettings(){
      const sec = clampInt(state.settings.roundSeconds, 30, 300, 60);
      const win = clampInt(state.settings.winScore, 10, 200, 30);

      const rangeTime = el('input', {type:'range', min:'30', max:'300', step:'5', value:String(sec)});
      const rangeWin = el('input', {type:'range', min:'10', max:'200', step:'5', value:String(win)});

      const timePill = el('span', {class:'pill', text:`${sec} сек`});
      const winPill = el('span', {class:'pill', text:`${win} очков`});

      rangeTime.addEventListener('input', () => {
        const v = clampInt(rangeTime.value, 30, 300, 60);
        state.settings.roundSeconds = v;
        render();
      });
      rangeWin.addEventListener('input', () => {
        const v = clampInt(rangeWin.value, 10, 200, 30);
        state.settings.winScore = v;
        render();
      });

      return el('div', {class:'card'}, [
        el('h2', {text:'Настройки игры'}),
        el('div', {class:'row'}, [
          el('div', {}, [
            el('label', {text:'Время раунда'}),
            rangeTime,
            el('div', {class:'hint'}, ['Выбрано: ', timePill])
          ]),
        ]),
        el('div', {style:'height:8px'}),
        el('div', {class:'row'}, [
          el('div', {}, [
            el('label', {text:'Очков для победы'}),
            rangeWin,
            el('div', {class:'hint'}, ['Выбрано: ', winPill])
          ])
        ]),
        el('div', {style:'height:10px'}),
        el('button', {class:'btn primary', onClick: () => go(3)}, ['Далее'])
      ]);
    }

    function screenDifficulty(){
      const grid = el('div', {class:'modeGrid'});
      for (const m of MODES) {
        const isSel = m.key === state.modeKey;
        grid.appendChild(
          el('div', {class:'mode' + (isSel ? ' selected' : ''), onClick: () => {state.modeKey = m.key; render();}}, [
            el('div', {class:'modeTitle', text: m.title}),
            el('div', {class:'modeMeta', text: m.meta})
          ])
        );
      }

      const nowTeam = currentTeam();

      return el('div', {class:'card'}, [
        el('h2', {text:'Выбор сложности'}),
        el('p', {text:'Выберите режим: он влияет на штраф за пропуск и сложность слов.'}),
        grid,
        el('div', {style:'height:8px'}),
        el('div', {class:'pill', text:`Сейчас играет: ${safeText(nowTeam?.name, 'Команда')}`}),
        el('div', {style:'height:10px'}),
        el('button', {class:'btn green big', onClick: startRound}, ['Старт']),
        el('div', {style:'height:10px'}),
        scoreTable(nowTeam?.id)
      ]);
    }

    function attachSwipeHandlers(target){
      if (target && target.dataset && target.dataset.swipeAttached === '1') return;
      if (target && target.dataset) target.dataset.swipeAttached = '1';
      let startY = 0;
      let startX = 0;
      let active = false;

      const THRESH = 42;

      function onStart(e){
        const t = e.touches ? e.touches[0] : e;
        active = true;
        startY = t.clientY;
        startX = t.clientX;
        audio.ensure();
      }

      function onEnd(e){
        if (!active) return;
        active = false;
        const t = e.changedTouches ? e.changedTouches[0] : e;
        const dy = t.clientY - startY;
        const dx = t.clientX - startX;

        if (Math.abs(dx) > Math.abs(dy)) return;

        if (dy <= -THRESH) applySwipe('ok');
        else if (dy >= THRESH) applySwipe('skip');
      }

      target.addEventListener('touchstart', onStart, {passive:true});
      target.addEventListener('touchend', onEnd, {passive:true});
      target.addEventListener('mousedown', onStart);
      target.addEventListener('mouseup', onEnd);
    }

    function screenRound(){
      const r = state.round;
      if (!r) {
        return el('div', {class:'card'}, [
          el('h2', {text:'Раунд'}),
          el('p', {text:'Что-то пошло не так: раунд не создан. Вернёмся.'}),
          el('button', {class:'btn primary', onClick: () => go(3)}, ['К выбору сложности'])
        ]);
      }

      const rem = remainingSeconds();
      const shown = r.timeUp ? '0' : formatTime(rem);
      const timerCls = 'timer' + ((r.timeUp || rem <= 5) ? ' danger' : '');

      const wordBox = el('div', {class:'wordCard'}, [
        el('div', {class:'word', text: safeText(r.currentWord, 'слово')})
      ]);

      const container = el('div', {class:'card roundStage'});
      container.appendChild(
        el('div', {class:'topBar'}, [
          el('div', {class:'pill', text: safeText(currentTeam()?.name, 'Команда')}),
          el('div', {class: timerCls, text: shown})
        ])
      );

      container.appendChild(wordBox);

      container.appendChild(
        el('div', {class:'swipeHelp'}, [
          el('div', {text:'Свайп вверх — ✅ угадал (+1)'}),
          el('div', {text: `Свайп вниз — ❌ пропуск (${mode().skipPenalty ? '−1' : '0'})`})
        ])
      );

      container.appendChild(
        el('div', {class:'hint', text: r.timeUp ? 'Время вышло. Ответьте на это слово — и раунд завершится.' : 'Слова не повторяются в рамках раунда.'})
      );
      setTimeout(() => attachSwipeHandlers(wordBox), 0);

      return container;
    }

    function screenRoundResult(){
      const r = state.round;
      if (!r) {
        return el('div', {class:'card'}, [
          el('h2', {text:'Результат раунда'}),
          el('p', {text:'Не найден лог раунда. Вернёмся к следующему ходу.'}),
          el('button', {class:'btn primary', onClick: nextTurn}, ['Передать дальше'])
        ]);
      }

      const list = el('div', {class:'resultList'});
      for (const it of r.items) {
        const ok = it.result === 'ok';
        list.appendChild(
          el('div', {class:'res'}, [
            el('div', {class:'mark', text: ok ? '✅' : '❌'}),
            el('div', {class:'resWord', text: it.word})
          ])
        );
      }

      const delta = roundScoreDelta();
      const deltaText = delta >= 0 ? `+${delta}` : String(delta);

      return el('div', {class:'card'}, [
        el('h2', {text:'Результат раунда'}),
        el('p', {text:`Команда: ${safeText(currentTeam()?.name,'Команда')}. Итог раунда: ${deltaText}.`}),
        list,
        el('div', {style:'height:10px'}),
        el('button', {class:'btn primary big', onClick: nextTurn}, ['Передать дальше'])
      ]);
    }

    function screenNextTurn(){
      const ct = currentTeam();
      return el('div', {class:'card'}, [
        el('h2', {text:'Следующий ход'}),
        el('p', {text:'Передайте телефон следующему игроку. Готовы?'}),
        scoreTable(ct?.id),
        el('div', {style:'height:10px'}),
        el('div', {class:'pill', text:`Сейчас играет: ${safeText(ct?.name,'Команда')}`}),
        el('div', {style:'height:10px'}),
        el('button', {class:'btn green big', onClick: startRound}, ['Старт'])
      ]);
    }

    function screenWin(){
      const winner = state.teams.find(t => t.id === state.winnerTeamId) || state.teams[0];
      return el('div', {class:'card'}, [
        el('h2', {text:`Поздравляем! ${safeText(winner?.name,'Команда')} победила!`}),
        el('p', {text:'Таблица результатов ниже. Можно сыграть ещё раз — с чистого листа.'}),
        scoreTable(winner?.id),
        el('div', {style:'height:10px'}),
        el('button', {class:'btn primary big', onClick: resetGame}, ['Сыграем ещё раз?'])
      ]);
    }

    function render(){
      clear(APP);
      state.settings.roundSeconds = clampInt(state.settings.roundSeconds, 30, 300, 60);
      state.settings.winScore = clampInt(state.settings.winScore, 10, 200, 30);
      state.turnIndex = clampInt(state.turnIndex, 0, Math.max(0, state.teams.length - 1), 0);
      if (state.screen === 4 && !state.round) state.screen = 3;

      const screens = {
        0: screenStart,
        1: screenTeams,
        2: screenSettings,
        3: screenDifficulty,
        4: screenRound,
        5: screenRoundResult,
        6: screenNextTurn,
        7: screenWin
      };

      const view = (screens[state.screen] || screenStart)();
      APP.appendChild(view);
    }
    rebuildTeams(state.teamsCount);
    render();
    window.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopRoundTimer();
      } else {
        if (state.screen === 4 && state.round && !state.round.timeUp && !state.round.timerHandle) {
          tickRound();
          state.round.timerHandle = setInterval(tickRound, 200);
        }
      }
    });

  })();
  </script>
</body>
</html>

